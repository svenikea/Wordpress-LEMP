version: '3'

volumes:
        wordpress:
        db:

services:
        wordpress:
                image: wordpress:5.8.2-fpm-alpine
                restart: always
                container_name: ${WP_CONTAINER_NAME}
                hostname: ${WP_HOSTNAME}
                environment:
                        WORDPRESS_DB_HOST: ${DATABASE_HOSTNAME}:3306
                        WORDPRESS_DB_USER: ${DATABASE_USERNAME}
                        WORDPRESS_DB_PASSWORD: ${DATABASE_PASSWORD}
                        WORDPRESS_DB_NAME: ${DATABASE_TABLE}
                        WORDPRESS_TABLE_PREFIX: wp_
                        WORDPRESS_DEBUG: 1
                        WORDPRESS_CONFIG_EXTRA: |
                                define('DOMAIN_CURRENT_SITE', '${WP_SERVER_NAME}'); // TODO: change to actual domain when deploying
                                define('PATH_CURRENT_SITE', '/');
                                define('FORCE_SSL_ADMIN', true);
                                define('FORCE_SSL_LOGIN', true);
                volumes:
                        - wordpress:/var/www/html
                        - php/php.ini:/usr/local/etc/php/php.ini
                depends_on:
                        - db
                ports:
                        - 9000:9000

        db:
                image: mysql:5.7
                restart: always
                hostname: ${DATABASE_HOSTNAME}
                container_name: ${DATABASE_CONTAINER_NAME}
                environment:
                        MYSQL_DATABASE: ${DATABASE_TABLE}
                        MYSQL_USER: ${DATABASE_USERNAME}
                        MYSQL_PASSWORD: ${DATABASE_PASSWORD}
                        MYSQL_RANDOM_ROOT_PASSWORD: '1'
                volumes:
                        - db:/var/lib/mysql
                ports:
                        - 3306:3306
        web:
                image: nginx:1.21.4-alpine
                hostname: ${NGINX_HOSTNAME}
                container_name: ${NGINX_CONTAINER_NAME}
                ports:
                        - 80:80
                        - 443:443
                volumes:
                        - wordpress:/var/www/html
                        - ./nginx/my-default.conf:/etc/nginx/conf.d/wordpress.conf
                        - ./nginx/ssl:/etc/nginx/certs/
                depends_on:
                        - db
                        - wordpress
networks:
        default:
                external:
                        name: ${NETWORK}
